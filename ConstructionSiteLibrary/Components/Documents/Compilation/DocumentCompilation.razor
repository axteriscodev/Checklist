@using Shared.Documents
@using Microsoft.JSInterop

@inject DocumentsRepository DocumentsRepository
@inject IJSRuntime JS

@if (onLoading)
{
    <Loading />
}
else
{
    <div class="card shadow DocumentCard">
        <div id="stampaPDF">
            <ReportConstructorSiteDataSection Document="@document" />
            <CompaniesPresentSection Companies="@document.Companies" />
            <QuestionsSection Categories="document.Categories" Companies="document.Companies" OnStateChangeNotification="@QuestionNoteUpdated" />
            <FormQuestionAdditionalNotesList Document="@document" />
            <CompaniesSignsSection Document="@document" />
        </div>
    </div>
    <RadzenButton Text="Stampa" Click="StampaDocumento" />
}

@code {
    [Parameter]
    public int DocumentId { get; set; }
    private DocumentModel document = new();
    private bool onLoading = false;

    protected override async Task OnInitializedAsync()
    {
        onLoading = true;
        await base.OnInitializedAsync();
        await LoadData();
        onLoading = false;
    }
    private async Task LoadData()
    {
        document = await DocumentsRepository.GetDocumentById(DocumentId);
    }

    private void QuestionNoteUpdated()
    {
        StateHasChanged();
    }

    private async Task StampaDocumento()
    {
        var fileName = "documento-" + document.Title + ".pdf";
        var jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./_content/ConstructionSiteLibrary/pdfManager.js");
        // Generate and download the PDF
        await jsModule.InvokeVoidAsync("generaPDFDocumento2", fileName);
        //await jsModule.InvokeVoidAsync("CreateDocumentPages");
    }

}
